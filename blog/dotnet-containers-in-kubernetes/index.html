<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Running dotnet containers in kubernetes &#183; Kristoffer Lind - Developer, Technologist, Blogger</title>
<meta name=description content="Caveats when running dotnet applications in docker images on kubernetes">
<link rel=canonical href=/blog/dotnet-containers-in-kubernetes/>
<style>*{line-height:1.5}html,body{color:#555;background-color:#fff;margin:0;padding:0}html{font-family:times new roman,Times,serif;font-size:14px;overflow-y:scroll}@media(min-width:600px){html{font-size:18px}}h1,h2,h3,h4,h5,h6,.heading{color:#353535;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;line-height:normal}a{color:#4a9ae1;text-decoration:none}blockquote{border-left:.25rem solid #e5e5e5;color:#979797;margin:.8rem 0;padding:.5rem 1rem}blockquote p:last-child{margin-bottom:0}@media(min-width:600px){blockquote{padding:0 5rem 0 1.25rem}}img{display:block;margin:0 0 1rem;max-width:100%;object-fit:scale-down}td{vertical-align:top}@media(prefers-color-scheme:dark){html,body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,.heading{color:#ccc}blockquote{color:#979797}}.highlight pre{padding:1rem;border-radius:3px;overflow-x:auto;font-size:.8rem}.post{padding:3rem 0}.post-info{color:#aaa;font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;letter-spacing:.5px;text-align:center}.post-info span{font-style:italic}.post-title{color:#353535;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:2rem;margin:1rem 0;text-align:center}@media(min-width:600px){.post-title{font-size:3rem}}.post-line{border-top:.4rem solid #353535;display:block;margin:0 auto 3rem;width:4rem}.post p{margin:0 0 1rem;text-align:justify}.post a:hover{text-decoration:underline}.post img{margin:0 auto .5rem}.post img+em{color:#aaa;display:block;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:.9rem;font-style:normal;text-align:center}@media(prefers-color-scheme:dark){.post-info{color:#ccc}.post-title{color:#eee}.post img+em{color:#ccc}}.container{margin:0 auto;max-width:800px;width:80%}main,footer,.nav-container{display:block;margin:0 auto;max-width:800px;width:80%}.nav{box-shadow:0 2px 2px -2px rgba(0,0,0,.2);overflow:auto}.nav-container{margin:1rem auto;position:relative;text-align:center}.nav-title{color:#555;display:inline-block;margin:0;padding-right:.2rem}.nav-title:hover,.nav-title:focus{opacity:.6}.nav ul{list-style-type:none;margin:1rem 0 0;padding:0;text-align:center}.nav li{color:#555;display:inline-block;opacity:.6;padding:0 2rem 0 0}.nav li:last-child{padding-right:0}.nav li:hover,.nav li:focus{opacity:1}.nav a{color:#555;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif}@media(min-width:600px){.nav-container{text-align:left}.nav ul{bottom:0;position:absolute;right:0}}footer{font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;padding:2rem 0;text-align:center}footer span{color:#555;font-size:.8rem}@media(prefers-color-scheme:dark){.nav{box-shadow:0 2px 2px -2px rgba(255,255,255,.2)}.nav-title{color:#ddd}.nav li{color:#ddd}.nav a{color:#ddd}footer span{color:#ddd}}.pagination{border-top:.5px solid #e5e5e5;font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;padding-top:2rem;position:relative;text-align:center}.pagination span{color:#353535;font-size:1.1rem}.pagination .top{color:#555;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:1.1rem;opacity:.6}.pagination .top:hover{opacity:1}.pagination .arrow{color:#555;position:absolute}.pagination .arrow:hover,.pagination .arrow:focus{opacity:.6;text-decoration:none}.pagination .left{left:0}.pagination .right{right:0}@media(prefers-color-scheme:dark){.pagination span{color:#ccc}.pagination .top{color:#ddd}.pagination .arrow{color:#ddd}}.catalogue-item{border-bottom:1px solid #e5e5e5;display:block;padding:2rem 0}.catalogue-item:hover .catalogue-line,.catalogue-item:focus .catalogue-line{width:5rem}.catalogue-item:last-child{border:0}.catalogue-item a.entry{color:#555}.catalogue-time{color:#aaa;font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;letter-spacing:.5px}.catalogue-title{color:#353535;display:block;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:1.6rem;font-weight:700;margin:.5rem 0}@media(min-width:600px){.catalogue-title{font-size:1.8rem}}.catalogue-line{border-top:.2rem solid #353535;display:block;width:2rem}.catalogue p{margin-bottom:.25rem}.catalogue .tags{display:flex;justify-content:flex-end}.catalogue.archive{margin-bottom:.25rem}.catalogue.archive article{box-sizing:border-box;display:flex;justify-content:space-between}@media(prefers-color-scheme:dark){.catalogue-item a.entry{color:#eee}.catalogue-title{color:#ddd}}</style>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<link href rel=alternate type=application/rss+xml title="Kristoffer Lind - Developer, Technologist, Blogger">
<script async type=text/javascript src=https://www.lind.sh/js/index.79b056912be7157f2501588e9a504af685b2c5e0f50a84a4699aedebeec5a92b27ceccb62d381eaa7f263026fa2836d5628e85f5478b70da6a9c7f2648c5344d.js integrity="sha512-ebBWkSvnFX8lAViOmlBK9oWyxeD1CoSkaZrt6+7FqSsnzsy2LTgeqn8mMCb6KDbVYo6F9UeLcNpqnH8mSMU0TQ=="></script>
</head>
<body>
<nav class=nav>
<div class=nav-container>
<a href=/>
<h2 class=nav-title>Kristoffer Lind</h2>
</a>
<ul>
<li>
<a href=/about/>
<span>Who am I?</span>
</a>
</li>
</ul>
</div>
</nav>
<main>
<div class=post>
<div class=post-info>
<span>Written by</span>
Kristoffer Lind
<br>
<span>on&nbsp;</span><time datetime="December 4, 2021">December 4, 2021</time>
</div>
<h1 class=post-title>Running dotnet containers in kubernetes</h1>
<div class=post-line></div>
<p>There are some caveats to running dotnet in containers. You might expect that the docker images you pulled from Microsoft&rsquo;s container registry were checked for vulnerabilities and prepared to run in a containerized environment. If you&rsquo;ve gone with defaults and don&rsquo;t have strict rules on your cluster you&rsquo;ll have an image configured to run alone on a server (which is not a usual setup in a containerized environment) that is also full of known vulnerabilities even when fresh. To be fair though this is a very common problem with docker images.</p>
<h1 id=performance>
<a href=#performance class=heading>Performance</a>
</h1>
<h2 id=garbage-collection>
<a href=#garbage-collection class=heading>Garbage collection</a>
</h2>
<p>In default configuration these images are going to operate as if they&rsquo;re the only thing running on that node. Garbage collection will not happen until it&rsquo;s using 90% of the available memory. It thinks it has all of the node&rsquo;s memory to itself and garbage collection therefore never happens.</p>
<p>Setting memory limits for the deployment should mean that heap limit is set to 75% of that value. That default value is applied if the process knows it&rsquo;s running in a container and HeapHardLimitPercent is not set. Heap limit can also be configured by setting environment variables <code>COMPlus_GCHeapHardLimit</code> (.NET core 3.0 or later) or <code>DOTNET_GCHeapHardLimit</code> (.NET 6 or later). Values should be defined as bytes in hexadecimal. Heap limit setting is ignored if Per-object-heap limits are configured.</p>
<p>You might have skipped limits in your production environment to avoid OOMExceptions or CPU throttling. In reality though skipping those limits likely produces more exceptions than having sensible limits set.</p>
<h1 id=security>
<a href=#security class=heading>Security</a>
</h1>
<h2 id=known-vulnerabilities>
<a href=#known-vulnerabilities class=heading>Known vulnerabilities</a>
</h2>
<p>Current version of mcr.microsoft.com/dotnet/runtime-deps:6.0 has 62 known vulnerabilities, of which 4 are listed as critical. Latest debian image from which it&rsquo;s derived has 60, with 4 critical. This is a pretty common scenario, most default tags of docker images derive from debian, which is full of known holes from the start. If you&rsquo;ve neglected updating the image for a while it&rsquo;ll have several hundred known vulnerabilities.</p>
<p>Do you want to sift through even 60 known vulnerabilities to make sure they don&rsquo;t affect you? No? Neither do I. Maybe the initial ones have been checked, but there&rsquo;s new ones reported daily, do you want to keep track of those?</p>
<p>They also supply alpine versions of their images, these have way less vulnerabilities to keep track of, pick those instead if you can. Current version of mcr.microsoft.com/dotnet/runtime-deps:6.0-alpine has 0 known vulnerabilities. These images also have vulnerabilities reported from time to time, but it&rsquo;s at a level where you can read up on them and decide whether or not to patch.</p>
<p>If you&rsquo;re doing any graphics work (generating excel files for example) and depend on libgdiplus you&rsquo;re stuck with the debian versions, unless you want to include edge testing libs in your production environment.</p>
<h2 id=docker-configuration>
<a href=#docker-configuration class=heading>Docker configuration</a>
</h2>
<p>Unless you set a user that application of yours is going to be running as root user. Again, this is very common in the docker ecosystem. The user isn&rsquo;t changed because you might want to install something more. I&rsquo;d prefer a security first approach where you&rsquo;d need to switch back to root user for those installs, which would also make it very visible that the root user is active.</p>
<p>Containers aren&rsquo;t magic, you should treat them sort of like any other server OS. That user running the application shouldn&rsquo;t be allowed to do a single thing more than it needs to. It should only have software required for running the application installed. They do however have the benefit that it&rsquo;s really easy to argue for them being immutable. No snowflake pet servers, thank you very much.</p>
</div>
<div class=pagination>
<a href=# class=top>Top</a>
</div>
</main>
<footer>
<span>
&copy; <time datetime="2023-11-21 20:29:13.17993721 +0000 UTC m=+0.035922273">2023</time> Kristoffer Lind. Made with <a href=https://gohugo.io rel=noopener>Hugo</a> using the <a href=https://github.com/kristofferlind/tale-hugo/ rel=noopener>Tale</a> theme.
</span>
</footer>
</body>
</html>