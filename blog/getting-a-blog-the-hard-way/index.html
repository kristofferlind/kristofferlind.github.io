<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Getting a blog the hard way &#183; Kristoffer Lind - Developer, Technologist, Blogger</title>
<meta name=description content="Kristoffer Lind is a software engineer and site reliability engineer with a broad technical interest.">
<link rel=canonical href=/blog/getting-a-blog-the-hard-way/>
<style>*{line-height:1.5}html,body{color:#555;background-color:#fff;margin:0;padding:0}html{font-family:times new roman,Times,serif;font-size:14px;overflow-y:scroll}@media(min-width:600px){html{font-size:18px}}h1,h2,h3,h4,h5,h6,.heading{color:#353535;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;line-height:normal}a{color:#4a9ae1;text-decoration:none}blockquote{border-left:.25rem solid #e5e5e5;color:#979797;margin:.8rem 0;padding:.5rem 1rem}blockquote p:last-child{margin-bottom:0}@media(min-width:600px){blockquote{padding:0 5rem 0 1.25rem}}img{display:block;margin:0 0 1rem;max-width:100%;object-fit:scale-down}td{vertical-align:top}@media(prefers-color-scheme:dark){html,body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,.heading{color:#ccc}blockquote{color:#979797}}.highlight pre{padding:1rem;border-radius:3px;overflow-x:auto;font-size:.8rem}.post{padding:3rem 0}.post-info{color:#aaa;font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;letter-spacing:.5px;text-align:center}.post-info span{font-style:italic}.post-title{color:#353535;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:2rem;margin:1rem 0;text-align:center}@media(min-width:600px){.post-title{font-size:3rem}}.post-line{border-top:.4rem solid #353535;display:block;margin:0 auto 3rem;width:4rem}.post p{margin:0 0 1rem;text-align:justify}.post a:hover{text-decoration:underline}.post img{margin:0 auto .5rem}.post img+em{color:#aaa;display:block;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:.9rem;font-style:normal;text-align:center}@media(prefers-color-scheme:dark){.post-info{color:#ccc}.post-title{color:#eee}.post img+em{color:#ccc}}.container{margin:0 auto;max-width:800px;width:80%}main,footer,.nav-container{display:block;margin:0 auto;max-width:800px;width:80%}.nav{box-shadow:0 2px 2px -2px rgba(0,0,0,.2);overflow:auto}.nav-container{margin:1rem auto;position:relative;text-align:center}.nav-title{color:#555;display:inline-block;margin:0;padding-right:.2rem}.nav-title:hover,.nav-title:focus{opacity:.6}.nav ul{list-style-type:none;margin:1rem 0 0;padding:0;text-align:center}.nav li{color:#555;display:inline-block;opacity:.6;padding:0 2rem 0 0}.nav li:last-child{padding-right:0}.nav li:hover,.nav li:focus{opacity:1}.nav a{color:#555;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif}@media(min-width:600px){.nav-container{text-align:left}.nav ul{bottom:0;position:absolute;right:0}}footer{font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;padding:2rem 0;text-align:center}footer span{color:#555;font-size:.8rem}@media(prefers-color-scheme:dark){.nav{box-shadow:0 2px 2px -2px rgba(255,255,255,.2)}.nav-title{color:#ddd}.nav li{color:#ddd}.nav a{color:#ddd}footer span{color:#ddd}}.pagination{border-top:.5px solid #e5e5e5;font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;padding-top:2rem;position:relative;text-align:center}.pagination span{color:#353535;font-size:1.1rem}.pagination .top{color:#555;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:1.1rem;opacity:.6}.pagination .top:hover{opacity:1}.pagination .arrow{color:#555;position:absolute}.pagination .arrow:hover,.pagination .arrow:focus{opacity:.6;text-decoration:none}.pagination .left{left:0}.pagination .right{right:0}@media(prefers-color-scheme:dark){.pagination span{color:#ccc}.pagination .top{color:#ddd}.pagination .arrow{color:#ddd}}.catalogue-item{border-bottom:1px solid #e5e5e5;display:block;padding:2rem 0}.catalogue-item:hover .catalogue-line,.catalogue-item:focus .catalogue-line{width:5rem}.catalogue-item:last-child{border:0}.catalogue-item a.entry{color:#555}.catalogue-time{color:#aaa;font-family:Palatino,palatino lt std,palatino linotype,book antiqua,georgia,serif;letter-spacing:.5px}.catalogue-title{color:#353535;display:block;font-family:helvetica neue,segoe ui,Helvetica,Arial,sans-serif;font-size:1.6rem;font-weight:700;margin:.5rem 0}@media(min-width:600px){.catalogue-title{font-size:1.8rem}}.catalogue-line{border-top:.2rem solid #353535;display:block;width:2rem}.catalogue p{margin-bottom:.25rem}.catalogue .tags{display:flex;justify-content:flex-end}.catalogue.archive{margin-bottom:.25rem}.catalogue.archive article{box-sizing:border-box;display:flex;justify-content:space-between}@media(prefers-color-scheme:dark){.catalogue-item a.entry{color:#eee}.catalogue-title{color:#ddd}}</style>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<link href rel=alternate type=application/rss+xml title="Kristoffer Lind - Developer, Technologist, Blogger">
<script async type=text/javascript src=https://www.lind.sh/js/index.79b056912be7157f2501588e9a504af685b2c5e0f50a84a4699aedebeec5a92b27ceccb62d381eaa7f263026fa2836d5628e85f5478b70da6a9c7f2648c5344d.js integrity="sha512-ebBWkSvnFX8lAViOmlBK9oWyxeD1CoSkaZrt6+7FqSsnzsy2LTgeqn8mMCb6KDbVYo6F9UeLcNpqnH8mSMU0TQ=="></script>
</head>
<body>
<nav class=nav>
<div class=nav-container>
<a href=/>
<h2 class=nav-title>Kristoffer Lind</h2>
</a>
<ul>
<li>
<a href=/about/>
<span>Who am I?</span>
</a>
</li>
</ul>
</div>
</nav>
<main>
<div class=post>
<div class=post-info>
<span>Written by</span>
Kristoffer Lind
<br>
<span>on&nbsp;</span><time datetime="March 10, 2019">March 10, 2019</time>
</div>
<h1 class=post-title>Getting a blog the hard way</h1>
<div class=post-line></div>
<p>The hard way is a path focused on learning, you should follow/replicate this if your aim is gaining knowledge. This post will serve as an overview, while going into a bit more details for sections where there&rsquo;s no separate post planned. Expect a lot of deep dives searching, especially if you do it before the detailed posts are available.</p>
<p>If you&rsquo;re more interested in the end result, follow these steps instead:</p>
<ol>
<li>Sign up for a hosted blog on ghost.org (atleast that&rsquo;s the service I&rsquo;d pick)</li>
<li>Buy a domain name</li>
<li>Sign up for a free Cloudflare account</li>
<li>Configure Cloudflare in front of your blog for some free goodies</li>
</ol>
<h1 id=overdoing-infrastructure>
<a href=#overdoing-infrastructure class=heading>Overdoing infrastructure</a>
</h1>
<p>First off, the reasonable hardware for running this blog and servicing the anticipated traffic is the equivalent of a raspberry pi, I probably can&rsquo;t serve more traffic with this considering my uplink, but it&rsquo;s serving it&rsquo;s purpose of experimentation and learning well.</p>
<h2 id=hardware>
<a href=#hardware class=heading>Hardware</a>
</h2>
<p>You should get a mimimum of 2 hosts, Dell Poweredge r710 are a good choice, they&rsquo;re really cheap(&lt;â‚¬100 for a low spec one), can be upgraded to 2x <a href=mailto:6core@3.46Ghz>6core@3.46Ghz</a>, 288GB ram and compared to many alternatives they&rsquo;re pretty quiet. There&rsquo;s no need to actually go with servers, but you&rsquo;re going to want some kind of setup that has a minimum of 32GB ram.</p>
<p>The VMs discussed throughout this post are using ~23GB on my cluster, but in total I&rsquo;m using 81GB after a year of experimentation, so if you can get a bit more it&rsquo;ll leave you more room for further experimentation.</p>
<h2 id=network-setup-dmz>
<a href=#network-setup-dmz class=heading>Network setup (DMZ)</a>
</h2>
<p>Setup a separate network (DMZ) and start it off by not allowing anything other than outbound internet access (nothing inbound yet), pick a subnet (so you can specify rules specifically for them) and put your hosts in it. Make sure to also configure DNS in this step (so you don&rsquo;t have to remember IPs for all your hosts and VMs).</p>
<h2 id=optional-automate-setting-up-a-bare-metal-kubernetes-cluster>
<a href=#optional-automate-setting-up-a-bare-metal-kubernetes-cluster class=heading>Optional: automate setting up a bare-metal Kubernetes cluster</a>
</h2>
<p>Using <a href=https://github.com/coreos/matchbox rel=noopener>Matchbox</a> you can control PXE/ignition provisioning on physical(or virtual) hosts using terraform. I went with <a href=https://github.com/poseidon/typhoon rel=noopener>typhoon</a> as a base to provision a Kubernetes cluster. I ended up scrapping it again, but I learned a lot about TFTP and PXE doing this.</p>
<p>The main reason for scrapping it was that it didn&rsquo;t feel flexible enough, so I kept digging around a bit and found that VMWare vSphere can be controlled by terraform. So let&rsquo;s give that a try.</p>
<h2 id=setup-esxi-on-hosts>
<a href=#setup-esxi-on-hosts class=heading>Setup ESXi on hosts</a>
</h2>
<p>Automating this using matchbox would be a good idea. I actually did it manually though (shame on me!), I&rsquo;ll fix that at some point. It&rsquo;s pretty straightforward, no different than installing any other OS, so get it done and give them DNS entries so you don&rsquo;t have to remember them by IP.</p>
<h2 id=provision-gitlab-for-source-control>
<a href=#provision-gitlab-for-source-control class=heading>Provision Gitlab for source control</a>
</h2>
<p>Yes, you could just put this on Github, but that would be cheating ;). Start off by creating a VM, 2vCPU, 8GB RAM and 20GB HDD should be enough for quite a while (mine&rsquo;s currently using 200Mhz, 1.5gGB RAM and 5GB HDD). Install <a href=https://about.gitlab.com/install/ rel=noopener>Gitlab</a> on it and give it a DNS entry. Use certbot with your challenge of choice (Cloudflare for example) for giving it a TLS certificate (it&rsquo;s nice to have and it&rsquo;s also going to be the easiest path for getting Gitlab Container Registry working later on). The harder path for getting Container registry working is also less secure.</p>
<h2 id=provision-gitlab-runner>
<a href=#provision-gitlab-runner class=heading>Provision Gitlab runner</a>
</h2>
<p>You&rsquo;ll also want runners for running both infrastructure and application deployment pipelines. I went for a <a href=https://docs.gitlab.com/runner/install/docker.html rel=noopener>docker service</a>, so that docker images can be used for steps. You might be tempted to use Kubernetes runners for application deployment pipelines, but you&rsquo;ll need privileged containers to be able to run Docker in Docker steps, making it impossible to run them on a secure Kubernetes cluster.</p>
<p>Now you&rsquo;ve got source control and a means to running pipelines when code is pushed, make sure to set up repositories and pipelines for upcoming steps.</p>
<h2 id=provision-kubernetes-cluster>
<a href=#provision-kubernetes-cluster class=heading>Provision Kubernetes cluster</a>
</h2>
<p>Remember to create a repository for this and hook up a pipeline. You should now automate provisioning your Kubernetes cluster. I went with <a href=https://github.com/kubernetes-sigs/kubespray rel=noopener>Kubespray</a>, creating the VMs for hosts using the VMWare provider and having the ansible inventory files as terraform templates so that they can be generated and populated by terraform.</p>
<p>Important: make sure to create a multi-master cluster, switching from single to multi-master is a bit of a pain and with single-master you can&rsquo;t do updates without downtime.</p>
<p>This isn&rsquo;t as nice to work with as kops, but it works. Please let me know if you find something that works better, I&rsquo;m not completely satisfied with this setup. There are plans to support vSphere in kops, so might be worth looking into that before diving too deep into this setup.</p>
<h2 id=configure-cluster>
<a href=#configure-cluster class=heading>Configure cluster</a>
</h2>
<p>Configure ingress controller, network policies, users/roles and namespaces using terraform and the kubernetes provider. It&rsquo;s a bit of extra work compared to just working with yaml files, but the fact that items removed from source are also removed from the cluster makes it worth it.</p>
<p>I&rsquo;ve run into a few issues with not all resources being supported by the provider, so I still have a few yaml files being applied as a step in the pipeline. But whatever you can convert to utilize the kubernetes provider will require less maintenance.</p>
<h2 id=security-checks-for-cluster>
<a href=#security-checks-for-cluster class=heading>Security checks for cluster</a>
</h2>
<p>First off you should run a <a href=https://github.com/aquasecurity/kube-hunter rel=noopener>kube-hunter</a> scan to look for vulnerabilities, you should also do both master and worker node scans using <a href=https://github.com/aquasecurity/kube-bench rel=noopener>kube-bench</a>, which compares your configuration with a CIS benchmark. These scans will raise awareness and will probably point out a few issues you&rsquo;ll want to fix before exposing anything. The kubernetes ecosystem does not have a security-first mentality.</p>
<h1 id=setting-up-the-blog>
<a href=#setting-up-the-blog class=heading>Setting up the blog</a>
</h1>
<p>I skimped out a bit on the hard way here, I should obviously have built my own custom blogging platform for this post to be entirely valid. The main reason for doing so is that I&rsquo;m currently more interested in the devops area, so I&rsquo;m cutting corners a bit to spend my time on what I find interesting.</p>
<h2 id=picking-a-blogging-platform>
<a href=#picking-a-blogging-platform class=heading>Picking a blogging platform</a>
</h2>
<p>I&rsquo;ve looked a bit at Ghost and I like the minimalism and focus of using markdown for posts, but I wanted to use a static site generator. Mostly for security reasons, I want this blog to be low maintenance and considering the amount of vulnerabilities that crop up for most blogging platforms and the fact that this would be one of the services exposed on my homelab I&rsquo;d have to keep up with it. Performance is another reason, going static and having a build step run every time I change the content enables really aggressive caching and pre-gzipped files.</p>
<p>After some digging around I ended up picking Gatsby. Being based on React it feels pretty natural and simple, again picking a path based on what I want to spend my time on. Any changes I&rsquo;d want to do would be fairly quick. It&rsquo;s rather efficient out of the box and has most of the desired tooling in place. Yes, there&rsquo;s plenty of room for optimization, this isn&rsquo;t even remotely interactive enough to warrant the amount of javascript, but it&rsquo;s ok for now according to lighthouse:</p>
<p>
<img alt="Lighthouse audit performance report showing 100/100 performance" src=initial-blog-lighthouse-audit.PNG width=694 height=97>
</p>
<p>Further cutting corners I went with one of the available starters.</p>
<h2 id=picking-a-starter>
<a href=#picking-a-starter class=heading>Picking a starter</a>
</h2>
<p>I prefer working on javascript over doing design work, so I picked a starter based on what they looked like rather than paying too much attention to what features were included and ended up picking <a href=https://github.com/scttcper/gatsby-casper rel=noopener>gatsby-casper</a>. It&rsquo;s not too far off from the feature set I&rsquo;d like either.</p>
<p>Create site:</p>
<ul>
<li><code>gatsby new site-name starter-url</code></li>
<li><code>cd site-name</code></li>
<li><code>gatsby develop</code></li>
</ul>
<h2 id=modifications-to-starter>
<a href=#modifications-to-starter class=heading>Modifications to starter</a>
</h2>
<p>I started off by adding build time gzipping, accomplished by adding <a href=https://www.gatsbyjs.org/packages/gatsby-plugin-zopfli/ rel=noopener>gatsby-plugin-zopfli</a>, saving the web server a bit of work and enables more CPU intensive compression as it doesn&rsquo;t have to be as fast.</p>
<p>Next up was removing google analytics, regular logs and Cloudflare give me more than enough statistics, no need to empower Google further, doing so is also a tiny performance gain.</p>
<p>Tags were added to enable sorting through the different types of content I envision this blog ending up having. Again there was a plugin available to sort it out: <a href=https://www.gatsbyjs.org/packages/gatsby-plugin-tags/ rel=noopener>gatsby-plugin-tags</a>.</p>
<p>After having run the Lighthouse audit I also fixed the PWA tests by configuring two additional plugins: <a href=https://www.gatsbyjs.org/packages/gatsby-plugin-manifest/ rel=noopener>gatsby-plugin-manifest</a> and <a href=https://www.gatsbyjs.org/packages/gatsby-plugin-offline/ rel=noopener>gatsby-plugin-offline</a>. However I removed them again because the serviceworker configuration was a bit too aggressive (downloaded all content right away). While this isn&rsquo;t really a problem now, it could have been when there&rsquo;s more content.</p>
<p>The starter had a subscription setup included, so I just registered for a Mailchimp account and hooked it up, noticed that they have an RSS to email feature, which hopefully can be used to automatically send emails for new posts, I&rsquo;ll look into this before posting my second article if there are any subscribers.</p>
<h3 id=disqus>
<a href=#disqus class=heading>Disqus</a>
</h3>
<p>Setting up Disqus for comments was really easy, basically just including a react component with some configuration.</p>
<p>I ended up removing it again though after noticing that in Chrome it injects iframes for both Google and Facebook, which in turn does a bunch of tracking, both of which were disallowed by both frame-src and connect-src (were set to &lsquo;self&rsquo; and disqus.com). Not sure what the CSP specification says about content inside an iframe, but I think Firefox handled it better as it loaded neither of the iframes, did no requests and only had the Disqus tracking.</p>
<p>Not acceptable, so no comments field for now. Going to see if I can find some other external service that does it better.</p>
<h3 id=draft-article-issues>
<a href=#draft-article-issues class=heading>Draft article issues</a>
</h3>
<p>There were also some issues with the draft setup, draft articles were included in the production build as reachable pages. They were filtered in the startpage listing, but not for previous/next alongside readnext.</p>
<p>Both issues can be fixed by editing gatsby-node a bit:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#75715e>// Create post pages
</span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>posts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>allMarkdownRemark</span>.<span style=color:#a6e22e>edges</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>post</span> =&gt; {
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NODE_ENV</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;production&#39;</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>edge</span>.<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>frontmatter</span>.<span style=color:#a6e22e>draft</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>;
  }
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
});
</code></pre></div><p>Replace <code>result.data.allMarkdownRemark.edges</code> with <code>posts</code> a bit further down to stop publishing tags with no corresponding published post aswell.</p>
<h3 id=fix-syntax-highlighting>
<a href=#fix-syntax-highlighting class=heading>Fix syntax highlighting</a>
</h3>
<p>Pick a theme and set it as an import in gatsby-browser.js</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#39;prismjs/themes/prism-okaidia.css&#39;</span>;
</code></pre></div><p>Finally I cleaned up the example content and replaced a bunch of placeholder content.</p>
<h1 id=setting-up-continuous-delivery>
<a href=#setting-up-continuous-delivery class=heading>Setting up continuous delivery</a>
</h1>
<h2 id=create-cd-pipeline>
<a href=#create-cd-pipeline class=heading>Create CD pipeline</a>
</h2>
<p>I&rsquo;ve got a CI image called shared-ci for reuse across projects, so I&rsquo;m basing my pipeline off of that. But it&rsquo;s actually based on Gitlabs autodevops configuration, so it might be a good idea to just make that work for you. The image is pretty much that setup modularized and customized a bit on an image.</p>
<p>First up is a build step for Gatsby:</p>
<ul>
<li><code>gatsby build</code></li>
</ul>
<p>Next up is creating a docker image with your application, one option is to just go with herokuish, another possibility is a custom image with your favorite webserver.</p>
<p>Finally for the actual deploy you should have a helm install (make sure you secure it, default tiller install is pretty insecure and will be used by an attacker to escalate to whatever role you gave that service account, first example being cluster-admin).</p>
<p>Try kubectl port-forward to make sure your service is working.</p>
<p>
<img alt="Blog continuous delivery pipeline" src=blog-cd-pipeline.PNG width=800 height=111>
</p>
<h2 id=configure-gitlab-container-registry>
<a href=#configure-gitlab-container-registry class=heading>Configure Gitlab Container Registry</a>
</h2>
<p>If you had or did a custom image for CI tools you&rsquo;ll want the container registry to publish it on. Whichever way you went you&rsquo;ll need an image registry for the application image your pipeline builds, so that it can be grabbed from there when deploying to Kubernetes. If all you need is a docker registry, it&rsquo;s a pretty nice solution as it enables an image repository for every repository you&rsquo;ve got.</p>
<h2 id=provision-public-load-balancer>
<a href=#provision-public-load-balancer class=heading>Provision public load balancer</a>
</h2>
<p>Get a load balancer running as an edge for your cluster, this will be the entrypoint, so spend a bit extra time hardening it. I set mine up so that I need to specify all the actual domains it should expose, no wildcard entries. Currently that means it&rsquo;s going to drop anything other than requests to <a href=http://www.lind.sh rel=noopener>www.lind.sh</a>.</p>
<p>Configure a letsencrypt certificate for the load balancer, along with cron job to auto renew it.</p>
<p>Once you&rsquo;ve got this running you should test it out by setting up an internal DNS for the service you&rsquo;re about to expose pointing to the load balancer.</p>
<h2 id=cloudflare-setup>
<a href=#cloudflare-setup class=heading>Cloudflare setup</a>
</h2>
<p>Configure your DNS so that you can control it from a Cloudflare account, take a look at the possible settings and configure to suit your site. Point your domain to your gateway and once you feel confident you&rsquo;ve got everything right, punch a hole through your gateway by setting up port forwarding to your load balancer.</p>
</div>
<div class=pagination>
<a href=# class=top>Top</a>
</div>
</main>
<footer>
<span>
&copy; <time datetime="2023-11-21 20:29:13.259699677 +0000 UTC m=+0.115684740">2023</time> Kristoffer Lind. Made with <a href=https://gohugo.io rel=noopener>Hugo</a> using the <a href=https://github.com/kristofferlind/tale-hugo/ rel=noopener>Tale</a> theme.
</span>
</footer>
</body>
</html>